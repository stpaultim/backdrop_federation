<?php
/**
 * @file
 * Backdrop Federation Follow sub-module.
 *
 * Allows this site to follow other Fediverse accounts and receive their posts
 * into a local feed.
 */

/**
 * Implements hook_views_api().
 */
function backdrop_federation_follow_views_api() {
  return array(
    'api' => '3.0',
    'path' => backdrop_get_path('module', 'backdrop_federation_follow') . '/views',
  );
}

/**
 * Implements hook_config_info().
 */
function backdrop_federation_follow_config_info() {
  return array(
    'backdrop_federation_follow.settings' => array(
      'label' => t('Fediverse Follow settings'),
      'group' => t('Configuration'),
    ),
  );
}

/**
 * Implements hook_cron().
 *
 * Deletes feed posts older than the configured retention period.
 */
function backdrop_federation_follow_cron() {
  $deleted = _backdrop_federation_follow_expire_feed_posts();
  if ($deleted) {
    watchdog('backdrop_federation_follow', 'Cron removed @count expired feed posts.', array('@count' => $deleted), WATCHDOG_INFO);
  }
}

/**
 * Delete feed posts older than the configured retention period.
 *
 * Shared by hook_cron() and the settings submit handler so that changing the
 * retention setting takes effect immediately rather than waiting for the next
 * cron run.
 *
 * @param int|null $retention
 *   Retention period in seconds, or NULL to read from config.
 *
 * @return int
 *   Number of posts deleted.
 */
function _backdrop_federation_follow_expire_feed_posts($retention = NULL) {
  if ($retention === NULL) {
    $retention = config_get('backdrop_federation_follow.settings', 'feed_retention');
  }

  // 0 / empty means keep forever.
  if (empty($retention) || $retention === '0' || (int) $retention === 0) {
    return 0;
  }

  return (int) db_delete('backdrop_federation_feed')
    ->condition('received', REQUEST_TIME - (int) $retention, '<')
    ->execute();
}

/**
 * Implements hook_menu().
 */
function backdrop_federation_follow_menu() {
  $items = array();

  // Following management tab.
  $items['admin/config/services/fediverse/following'] = array(
    'title' => 'Following',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('backdrop_federation_follow_admin_form'),
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 15,
  );

  // Incoming feed tab.
  $items['admin/config/services/fediverse/feed'] = array(
    'title' => 'Feed',
    'page callback' => 'backdrop_federation_follow_admin_feed_page',
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 17,
  );

  // Unfollow confirm page.
  $items['admin/config/services/fediverse/following/unfollow/%'] = array(
    'title' => 'Unfollow',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('backdrop_federation_follow_unfollow_confirm', 6),
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_CALLBACK,
  );

  // Pause confirm page.
  $items['admin/config/services/fediverse/following/pause/%'] = array(
    'title' => 'Pause',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('backdrop_federation_follow_pause_confirm', 6),
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_CALLBACK,
  );

  // Pause all confirm page.
  $items['admin/config/services/fediverse/following/pause-all'] = array(
    'title' => 'Pause all',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('backdrop_federation_follow_pause_all_confirm'),
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_CALLBACK,
  );

  // Resume confirm page.
  $items['admin/config/services/fediverse/following/resume/%'] = array(
    'title' => 'Resume',
    'page callback' => 'backdrop_get_form',
    'page arguments' => array('backdrop_federation_follow_resume_confirm', 6),
    'access arguments' => array('administer backdrop_federation'),
    'file' => 'backdrop_federation_follow.admin.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_backdrop_federation_inbox_activity().
 *
 * Processes incoming ActivityPub activities relevant to accounts we follow:
 * - Accept/Reject: updates the follow status in our following table.
 * - Create/Update/Delete: stores or removes posts in the local feed.
 *
 * @param array $activity
 *   The incoming ActivityPub activity array.
 */
function backdrop_federation_follow_backdrop_federation_inbox_activity($activity) {
  $type = isset($activity['type']) ? $activity['type'] : '';
  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';

  switch ($type) {
    case 'Accept':
      // Remote server accepted our Follow request — mark as accepted.
      $updated = db_update('backdrop_federation_following')
        ->fields(array('status' => 'accepted'))
        ->condition('actor_uri', $actor_uri)
        ->condition('status', 'pending')
        ->execute();

      if ($updated) {
        watchdog('backdrop_federation_follow', 'Follow accepted by @actor', array('@actor' => $actor_uri), WATCHDOG_INFO);
      }
      break;

    case 'Reject':
      // Remote server rejected our Follow request.
      db_update('backdrop_federation_following')
        ->fields(array('status' => 'rejected'))
        ->condition('actor_uri', $actor_uri)
        ->condition('status', 'pending')
        ->execute();

      watchdog('backdrop_federation_follow', 'Follow rejected by @actor', array('@actor' => $actor_uri), WATCHDOG_WARNING);
      break;

    case 'Announce':
      _backdrop_federation_follow_handle_announce($activity);
      break;

    case 'Undo':
      _backdrop_federation_follow_handle_undo($activity);
      break;

    case 'Create':
      _backdrop_federation_follow_handle_create($activity);
      break;

    case 'Update':
      _backdrop_federation_follow_handle_update($activity);
      break;

    case 'Delete':
      _backdrop_federation_follow_handle_delete($activity);
      break;
  }
}

/**
 * Store a new post from a followed account in the local feed.
 *
 * @param array $activity
 *   The incoming Create activity.
 */
function _backdrop_federation_follow_handle_create($activity) {
  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';
  if (!$actor_uri) {
    return;
  }

  // Only store posts from accounts we actively follow (and whose follow is accepted).
  $following = db_select('backdrop_federation_following', 'f')
    ->fields('f', array('id', 'status'))
    ->condition('actor_uri', $actor_uri)
    ->execute()
    ->fetchObject();

  if (!$following || $following->status !== 'accepted') {
    return;
  }

  $object = isset($activity['object']) ? $activity['object'] : NULL;
  if (!is_array($object) || empty($object['id'])) {
    return;
  }

  // Deduplicate by object ID.
  $existing = db_select('backdrop_federation_feed', 'f')
    ->fields('f', array('id'))
    ->condition('object_id', substr($object['id'], 0, 2048))
    ->execute()
    ->fetchField();

  if ($existing !== FALSE) {
    return;
  }

  $content = isset($object['content']) ? _backdrop_federation_follow_strip_emoji(filter_xss($object['content'], array('a', 'em', 'strong', 'cite', 'blockquote', 'code', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'p', 'br', 'span'))) : '';
  $published = !empty($object['published']) ? strtotime($object['published']) : REQUEST_TIME;
  $object_type = isset($object['type']) ? $object['type'] : 'Note';

  db_insert('backdrop_federation_feed')
    ->fields(array(
      'actor_uri' => $actor_uri,
      'object_id' => substr($object['id'], 0, 2048),
      'object_type' => $object_type,
      'activity_type' => 'Create',
      'content' => $content,
      'object_json' => json_encode($object, JSON_UNESCAPED_SLASHES),
      'published' => $published,
      'received' => REQUEST_TIME,
    ))
    ->execute();

  watchdog('backdrop_federation_follow', 'Stored post from @actor in feed.', array('@actor' => $actor_uri), WATCHDOG_INFO);
}

/**
 * Update a stored feed post when an Update activity arrives.
 *
 * @param array $activity
 *   The incoming Update activity.
 */
function _backdrop_federation_follow_handle_update($activity) {
  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';
  $object = isset($activity['object']) ? $activity['object'] : NULL;

  if (!is_array($object) || empty($object['id'])) {
    return;
  }

  $object_id = substr($object['id'], 0, 2048);

  $existing = db_select('backdrop_federation_feed', 'f')
    ->fields('f', array('id'))
    ->condition('object_id', $object_id)
    ->condition('actor_uri', $actor_uri)
    ->execute()
    ->fetchField();

  if ($existing === FALSE) {
    return;
  }

  $content = isset($object['content']) ? _backdrop_federation_follow_strip_emoji(filter_xss($object['content'], array('a', 'em', 'strong', 'cite', 'blockquote', 'code', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'p', 'br', 'span'))) : '';

  db_update('backdrop_federation_feed')
    ->fields(array(
      'content' => $content,
      'object_json' => json_encode($object, JSON_UNESCAPED_SLASHES),
      'activity_type' => 'Update',
    ))
    ->condition('object_id', $object_id)
    ->execute();

  watchdog('backdrop_federation_follow', 'Updated feed post from @actor.', array('@actor' => $actor_uri), WATCHDOG_DEBUG);
}

/**
 * Remove a post from the feed when a Delete activity arrives.
 *
 * @param array $activity
 *   The incoming Delete activity.
 */
function _backdrop_federation_follow_handle_delete($activity) {
  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';
  $object = isset($activity['object']) ? $activity['object'] : NULL;

  if (is_string($object)) {
    $object_id = $object;
  }
  elseif (is_array($object) && !empty($object['id'])) {
    $object_id = $object['id'];
  }
  else {
    return;
  }

  db_delete('backdrop_federation_feed')
    ->condition('object_id', substr($object_id, 0, 2048))
    ->condition('actor_uri', $actor_uri)
    ->execute();
}

/**
 * Remove a post from the feed when a followed account un-boosts it.
 *
 * Only handles Undo Announce. Other Undo types (Follow, Like) are ignored
 * here — they are handled by the parent module.
 *
 * @param array $activity
 *   The incoming Undo activity.
 */
function _backdrop_federation_follow_handle_undo($activity) {
  $undo_type = isset($activity['object']['type']) ? $activity['object']['type'] : '';
  if ($undo_type !== 'Announce') {
    return;
  }

  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';
  if (!$actor_uri) {
    return;
  }

  // The boosted post URI is the inner object of the Announce.
  $boosted = isset($activity['object']['object']) ? $activity['object']['object'] : NULL;
  if (!$boosted) {
    return;
  }

  // May arrive as a plain URI string or as an embedded object.
  if (is_array($boosted)) {
    $boosted = isset($boosted['id']) ? $boosted['id'] : NULL;
  }

  if (!$boosted) {
    return;
  }

  db_delete('backdrop_federation_feed')
    ->condition('actor_uri', $actor_uri)
    ->condition('object_id', substr($boosted, 0, 2048))
    ->condition('activity_type', 'Announce')
    ->execute();

  watchdog('backdrop_federation_follow', 'Removed un-boosted post from feed (actor: @actor).', array('@actor' => $actor_uri), WATCHDOG_INFO);
}

/**
 * Store a boosted post from a followed account in the local feed.
 *
 * Only runs when the global "include_boosts" setting is enabled. Fetches the
 * boosted object from the remote server if it is not embedded in the activity.
 * Deduplicates by object_id so the same post is never stored twice regardless
 * of how many followed accounts boost it.
 *
 * @param array $activity
 *   The incoming Announce activity.
 */
function _backdrop_federation_follow_handle_announce($activity) {
  if (!config_get('backdrop_federation_follow.settings', 'include_boosts')) {
    return;
  }

  $actor_uri = isset($activity['actor']) ? $activity['actor'] : '';
  if (!$actor_uri) {
    return;
  }

  // Only process boosts from accounts we actively follow.
  $following = db_select('backdrop_federation_following', 'f')
    ->fields('f', array('id', 'status'))
    ->condition('actor_uri', $actor_uri)
    ->execute()
    ->fetchObject();

  if (!$following || $following->status !== 'accepted') {
    return;
  }

  $object = isset($activity['object']) ? $activity['object'] : NULL;
  if (!$object) {
    return;
  }

  // If the object is a URI string, fetch the full object from the remote server.
  if (is_string($object)) {
    $object = _backdrop_federation_follow_fetch_object($object);
    if (!$object) {
      watchdog('backdrop_federation_follow', 'Could not fetch boosted object for Announce from @actor.', array('@actor' => $actor_uri), WATCHDOG_WARNING);
      return;
    }
  }

  if (!is_array($object) || empty($object['id'])) {
    return;
  }

  // Deduplicate globally — if we already have this post (via Create or a
  // previous boost), skip it to avoid showing the same content twice.
  $existing = db_select('backdrop_federation_feed', 'f')
    ->fields('f', array('id'))
    ->condition('object_id', substr($object['id'], 0, 2048))
    ->execute()
    ->fetchField();

  if ($existing !== FALSE) {
    return;
  }

  $content     = isset($object['content']) ? _backdrop_federation_follow_strip_emoji(filter_xss($object['content'], array('a', 'em', 'strong', 'cite', 'blockquote', 'code', 'ul', 'ol', 'li', 'dl', 'dt', 'dd', 'p', 'br', 'span'))) : '';
  $published   = !empty($activity['published']) ? strtotime($activity['published']) : REQUEST_TIME;
  $object_type = isset($object['type']) ? $object['type'] : 'Note';

  db_insert('backdrop_federation_feed')
    ->fields(array(
      'actor_uri'     => $actor_uri,
      'object_id'     => substr($object['id'], 0, 2048),
      'object_type'   => $object_type,
      'activity_type' => 'Announce',
      'content'       => $content,
      'object_json'   => json_encode($object, JSON_UNESCAPED_SLASHES),
      'published'     => $published,
      'received'      => REQUEST_TIME,
    ))
    ->execute();

  watchdog('backdrop_federation_follow', 'Stored boost from @actor in feed.', array('@actor' => $actor_uri), WATCHDOG_INFO);
}

/**
 * Fetch a remote ActivityPub object by URI.
 *
 * @param string $uri
 *   The object URI to fetch.
 *
 * @return array|false
 *   Decoded object array, or FALSE on failure.
 */
function _backdrop_federation_follow_fetch_object($uri) {
  $response = backdrop_http_request($uri, array(
    'headers' => array(
      'Accept' => 'application/activity+json, application/ld+json',
    ),
    'timeout' => 10,
  ));

  if ($response->code != 200) {
    return FALSE;
  }

  $data = json_decode($response->data, TRUE);
  return (is_array($data) && !empty($data['id'])) ? $data : FALSE;
}

/**
 * Send a Follow activity to a remote actor's inbox.
 *
 * @param string $actor_uri
 *   The remote actor URI.
 * @param string $inbox_uri
 *   The remote inbox URI to POST to.
 *
 * @return string|false
 *   The Follow activity ID string on success, or FALSE on failure.
 */
function _backdrop_federation_follow_send_follow($actor_uri, $inbox_uri) {
  global $base_url;

  $activity_id = $base_url . '/fediverse/activity/follow/' . backdrop_hash_base64(uniqid('follow', TRUE));

  $activity = array(
    '@context' => 'https://www.w3.org/ns/activitystreams',
    'id' => $activity_id,
    'type' => 'Follow',
    'actor' => backdrop_federation_get_actor_uri(),
    'object' => $actor_uri,
  );

  $json = json_encode($activity, JSON_UNESCAPED_SLASHES);

  module_load_include('inc', 'backdrop_federation', 'includes/backdrop_federation.http_signature');
  $result = backdrop_federation_post_to_inbox($inbox_uri, $json);

  return ($result !== FALSE) ? $activity_id : FALSE;
}

/**
 * Send an Undo Follow activity to a remote actor's inbox.
 *
 * @param string $actor_uri
 *   The remote actor URI.
 * @param string $inbox_uri
 *   The remote inbox URI to POST to.
 * @param string $follow_activity_id
 *   The ID of the original Follow activity being undone.
 *
 * @return bool
 *   TRUE if the request was sent successfully.
 */
function _backdrop_federation_follow_send_unfollow($actor_uri, $inbox_uri, $follow_activity_id) {
  global $base_url;

  $activity = array(
    '@context' => 'https://www.w3.org/ns/activitystreams',
    'id' => $base_url . '/fediverse/activity/unfollow/' . backdrop_hash_base64(uniqid('unfollow', TRUE)),
    'type' => 'Undo',
    'actor' => backdrop_federation_get_actor_uri(),
    'object' => array(
      'id' => $follow_activity_id,
      'type' => 'Follow',
      'actor' => backdrop_federation_get_actor_uri(),
      'object' => $actor_uri,
    ),
  );

  $json = json_encode($activity, JSON_UNESCAPED_SLASHES);

  module_load_include('inc', 'backdrop_federation', 'includes/backdrop_federation.http_signature');
  return backdrop_federation_post_to_inbox($inbox_uri, $json) !== FALSE;
}

/**
 * Resolve a @user@domain handle to actor data via WebFinger.
 *
 * @param string $handle
 *   The handle (with or without leading @), e.g. "user@mastodon.social".
 *
 * @return array|false
 *   Associative array with keys: actor_uri, inbox_uri, username, domain,
 *   display_name, avatar_url. Returns FALSE on failure.
 */
function _backdrop_federation_follow_resolve_handle($handle) {
  $handle = ltrim($handle, '@');
  $parts = explode('@', $handle, 2);
  if (count($parts) !== 2) {
    return FALSE;
  }
  list($username, $domain) = $parts;

  // WebFinger to get the actor URI.
  $webfinger_url = 'https://' . $domain . '/.well-known/webfinger?resource=' . urlencode('acct:' . $username . '@' . $domain);
  $response = backdrop_http_request($webfinger_url, array(
    'headers' => array('Accept' => 'application/jrd+json, application/json'),
    'timeout' => 10,
  ));

  if ($response->code != 200) {
    watchdog('backdrop_federation_follow', 'WebFinger lookup failed for @handle: HTTP @code', array(
      '@handle' => '@' . $handle,
      '@code' => $response->code,
    ), WATCHDOG_WARNING);
    return FALSE;
  }

  $data = json_decode($response->data, TRUE);
  $actor_uri = NULL;
  foreach ((array) $data['links'] as $link) {
    if (isset($link['rel'], $link['href']) && $link['rel'] === 'self' &&
        isset($link['type']) && strpos($link['type'], 'activity+json') !== FALSE) {
      $actor_uri = $link['href'];
      break;
    }
  }

  if (!$actor_uri) {
    watchdog('backdrop_federation_follow', 'No actor URI found in WebFinger response for @handle', array('@handle' => '@' . $handle), WATCHDOG_WARNING);
    return FALSE;
  }

  // Fetch the full actor object.
  module_load_include('inc', 'backdrop_federation', 'backdrop_federation.pages');
  $actor = _backdrop_federation_fetch_actor($actor_uri);
  if (!$actor) {
    return FALSE;
  }

  return array(
    'actor_uri' => $actor_uri,
    'inbox_uri' => $actor['inbox'],
    'username' => isset($actor['preferredUsername']) ? $actor['preferredUsername'] : $username,
    'domain' => $domain,
    'display_name' => isset($actor['name']) ? $actor['name'] : $username,
    'avatar_url' => isset($actor['icon']['url']) ? $actor['icon']['url'] : NULL,
  );
}

/**
 * Strip 4-byte UTF-8 characters (emoji etc.) that MySQL utf8 cannot store.
 *
 * MySQL's default utf8 charset only supports up to 3-byte characters.
 * Emoji and other supplementary-plane characters use 4 bytes and must be
 * removed before inserting into varchar/text columns.
 *
 * @param string $text
 *   The input string.
 *
 * @return string
 *   The string with 4-byte characters removed.
 */
function _backdrop_federation_follow_strip_emoji($text) {
  return preg_replace('/[\x{10000}-\x{10FFFF}]/u', '', trim($text));
}

/**
 * Implements hook_block_info().
 */
function backdrop_federation_follow_block_info() {
  return array(
    'fediverse_feed' => array(
      'info' => t('Fediverse Following Feed'),
      'description' => t('Displays recent posts from Fediverse accounts this site follows.'),
    ),
  );
}

/**
 * Implements hook_block_configure().
 */
function backdrop_federation_follow_block_configure($delta = '', $settings = array()) {
  $form = array();

  if ($delta === 'fediverse_feed') {
    $form['count'] = array(
      '#type' => 'select',
      '#title' => t('Number of posts to display'),
      '#options' => array(
        5  => 5,
        10 => 10,
        15 => 15,
        20 => 20,
        25 => 25,
        50 => 50,
      ),
      '#default_value' => isset($settings['count']) ? $settings['count'] : 10,
    );

    $form['show_avatars'] = array(
      '#type' => 'checkbox',
      '#title' => t('Show author avatars'),
      '#default_value' => isset($settings['show_avatars']) ? $settings['show_avatars'] : 1,
    );

    $form['truncate_length'] = array(
      '#type' => 'select',
      '#title' => t('Truncate post content at'),
      '#options' => array(
        0   => t('No truncation (full content)'),
        140 => t('140 characters'),
        280 => t('280 characters'),
        500 => t('500 characters'),
      ),
      '#default_value' => isset($settings['truncate_length']) ? $settings['truncate_length'] : 280,
    );

    $size_options = array(
      100 => t('100 px'),
      150 => t('150 px'),
      200 => t('200 px'),
      300 => t('300 px'),
      400 => t('400 px'),
    );

    $form['max_image_width'] = array(
      '#type' => 'select',
      '#title' => t('Max image width'),
      '#options' => $size_options,
      '#default_value' => isset($settings['max_image_width']) ? $settings['max_image_width'] : 200,
    );

    $form['max_image_height'] = array(
      '#type' => 'select',
      '#title' => t('Max image height'),
      '#options' => $size_options,
      '#default_value' => isset($settings['max_image_height']) ? $settings['max_image_height'] : 200,
    );
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function backdrop_federation_follow_block_save($delta = '', $edit = array()) {
  if ($delta === 'fediverse_feed') {
    return array(
      'count'            => (int) $edit['count'],
      'show_avatars'     => (int) $edit['show_avatars'],
      'truncate_length'  => (int) $edit['truncate_length'],
      'max_image_width'  => (int) $edit['max_image_width'],
      'max_image_height' => (int) $edit['max_image_height'],
    );
  }
}

/**
 * Extract a usable URL string from an ActivityPub 'url' value.
 *
 * The 'url' field in ActivityPub can be a plain string or an array of
 * Link objects (e.g. [{"type":"Link","href":"https://..."}]). This helper
 * returns a string URL or NULL if one cannot be found.
 */
function _backdrop_federation_follow_extract_url($value) {
  if (is_string($value)) {
    return $value;
  }
  if (is_array($value)) {
    foreach ($value as $link) {
      if (is_string($link)) {
        return $link;
      }
      if (is_array($link) && isset($link['href']) && is_string($link['href'])) {
        return $link['href'];
      }
    }
  }
  return NULL;
}

/**
 * Implements hook_block_view().
 */
function backdrop_federation_follow_block_view($delta = '', $settings = array(), $contexts = array()) {
  if ($delta !== 'fediverse_feed') {
    return array();
  }

  $count            = isset($settings['count'])            ? (int) $settings['count']            : 10;
  $show_avatars     = isset($settings['show_avatars'])     ? (bool) $settings['show_avatars']    : TRUE;
  $truncate_length  = isset($settings['truncate_length'])  ? (int) $settings['truncate_length']  : 280;
  $max_image_width  = isset($settings['max_image_width'])  ? (int) $settings['max_image_width']  : 200;
  $max_image_height = isset($settings['max_image_height']) ? (int) $settings['max_image_height'] : 200;

  $rows = db_select('backdrop_federation_feed', 'f')
    ->fields('f')
    ->orderBy('published', 'DESC')
    ->range(0, $count)
    ->execute()
    ->fetchAll();

  if (empty($rows)) {
    return array(
      'subject' => t('Fediverse Feed'),
      'content' => '<p>' . t('No posts yet.') . '</p>',
    );
  }

  // Pre-fetch all account info in one query to avoid N+1 queries in the loop.
  $actor_uris = array_unique(array_column((array) $rows, 'actor_uri'));
  $accounts = array();
  if (!empty($actor_uris)) {
    $result = db_select('backdrop_federation_following', 'f')
      ->fields('f', array('actor_uri', 'username', 'domain', 'display_name', 'avatar_url'))
      ->condition('actor_uri', $actor_uris, 'IN')
      ->execute();
    foreach ($result as $account) {
      $accounts[$account->actor_uri] = $account;
    }
  }

  $output = '';

  foreach ($rows as $row) {
    $account = isset($accounts[$row->actor_uri]) ? $accounts[$row->actor_uri] : NULL;

    $handle       = $account
      ? ('@' . check_plain($account->username) . '@' . check_plain($account->domain))
      : check_plain($row->actor_uri);
    $display_name = $account ? check_plain($account->display_name) : check_plain($row->actor_uri);

    $object       = json_decode($row->object_json, TRUE);
    $original_url = _backdrop_federation_follow_extract_url(
      isset($object['url']) ? $object['url'] : (isset($object['id']) ? $object['id'] : NULL)
    );

    // The stored content was already sanitized via filter_xss() at ingest time,
    // so it is safe to output as HTML — links, formatting, and mentions are
    // preserved. Only fall back to stripped plain text when truncation is
    // enabled and the content actually exceeds the limit.
    // Replace block-level closing tags with a space before stripping, so that
    // words from adjacent paragraphs don't run together in the plain-text
    // truncation path.
    $spaced = preg_replace('/<\/?(p|br|div|li)[^>]*>/i', ' ', $row->content);
    $plain  = trim(preg_replace('/\s+/', ' ', html_entity_decode(strip_tags($spaced), ENT_QUOTES, 'UTF-8')));
    if ($truncate_length > 0 && strlen($plain) > $truncate_length) {
      $text = check_plain(truncate_utf8($plain, $truncate_length, TRUE, TRUE));
    }
    else {
      // Output stored HTML (already sanitized via filter_xss at ingest), but
      // convert hashtag links to plain text — hashtag search URLs are
      // server-specific and don't work when clicked from another site.
      // Hashtag links are identified by rel="tag" per the ActivityPub spec.
      $text = preg_replace_callback(
        '/<a\b[^>]*\brel=["\'][^"\']*\btag\b[^"\']*["\'][^>]*>(.*?)<\/a>/is',
        function($matches) { return strip_tags($matches[1]); },
        $row->content
      );
    }

    // Avatar.
    $avatar_html = '';
    if ($show_avatars && $account && !empty($account->avatar_url)) {
      $avatar_html = '<img src="' . check_url($account->avatar_url) . '" alt=""'
        . ' class="fediverse-feed-avatar">';
    }

    $boost_line = '';
    if ($row->activity_type === 'Announce') {
      // Capture the booster's avatar before we replace the display info.
      $booster_avatar = $avatar_html;
      $boost_line = '<div class="fediverse-feed-boost">'
        . $booster_avatar
        . '&#x21BA; '
        . t('Boosted by !handle', array('!handle' => '<strong>' . $display_name . '</strong>'))
        . '</div>';
      // Replace main author line with original poster info from object JSON.
      $object_data    = json_decode($row->object_json, TRUE);
      $attributed_uri = isset($object_data['attributedTo']) ? $object_data['attributedTo'] : NULL;
      if ($attributed_uri) {
        $display_name = check_plain($attributed_uri);
        $handle       = '';
        $avatar_html  = '';
      }
    }

    $output .= '<div class="fediverse-feed-post">';
    $output .= $boost_line;
    $output .= '<p class="fediverse-feed-meta">'
      . $avatar_html
      . '<strong class="fediverse-feed-display-name">' . $display_name . '</strong>'
      . ($handle ? ' <span class="fediverse-feed-handle">' . $handle . '</span>' : '')
      . ' <span class="fediverse-feed-date">&middot; ' . format_date($row->published, 'short') . '</span>';
    if ($original_url) {
      $output .= ' <span class="fediverse-feed-link">&middot; '
        . l(t('View original'), $original_url, array('attributes' => array('target' => '_blank', 'rel' => 'noopener noreferrer')))
        . '</span>';
    }
    $output .= '</p>';
    $output .= '<div class="fediverse-feed-content">' . $text . '</div>';

    // Render image attachments.
    if (!empty($object['attachment']) && is_array($object['attachment'])) {
      foreach ($object['attachment'] as $attachment) {
        $url = isset($attachment['url']) ? $attachment['url'] : NULL;
        if (!$url || !filter_var($url, FILTER_VALIDATE_URL)) {
          continue;
        }
        $media_type = isset($attachment['mediaType']) ? $attachment['mediaType'] : '';
        $is_image = (strpos($media_type, 'image/') === 0)
          || (isset($attachment['type']) && $attachment['type'] === 'Image');
        if ($is_image) {
          $alt = isset($attachment['name']) ? check_plain($attachment['name']) : '';
          $output .= '<img src="' . check_url($url) . '" alt="' . $alt . '"'
            . ' class="fediverse-feed-image">';
        }
      }
    }

    $output .= '</div>';
  }

  if (user_access('administer backdrop_federation')) {
    $output .= '<p class="fediverse-feed-all">'
      . l(t('View all posts'), 'admin/config/services/fediverse/feed')
      . '</p>';
  }

  $css = '
    .fediverse-feed-post { border-bottom: 1px solid #ddd; padding: 0.75em 0; }
    .fediverse-feed-post:last-of-type { border-bottom: none; }
    .fediverse-feed-meta { margin: 0 0 0.4em; font-size: 0.9em; }
    .fediverse-feed-avatar { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 0.4em; }
    .fediverse-feed-handle { color: #666; }
    .fediverse-feed-date { color: #666; }
    .fediverse-feed-boost { font-size: 0.85em; color: #666; margin-bottom: 0.25em; }
    .fediverse-feed-content { margin: 0; }
    .fediverse-feed-image { max-width: ' . $max_image_width . 'px; max-height: ' . $max_image_height . 'px; width: auto; height: auto; display: block; margin-top: 0.5em; }
    .fediverse-feed-all { margin-top: 0.75em; font-size: 0.9em; }
  ';

  return array(
    'subject' => t('Fediverse Feed'),
    'content' => array(
      '#markup' => $output,
      '#attached' => array(
        'css' => array(
          array('data' => $css, 'type' => 'inline'),
        ),
      ),
    ),
  );
}
